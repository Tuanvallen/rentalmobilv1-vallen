{% extends "base.html" %}

{% block title %}Chat Support - Rental Mobil{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h2 fw-bold mb-2">Chat Support</h1>
                            <p class="text-muted mb-0">Hubungi admin untuk bantuan dan informasi</p>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="connection-status badge bg-warning rounded-pill p-2 me-3">
                                <i class="fas fa-circle"></i> Connecting...
                            </span>
                            <button class="btn btn-primary me-2" onclick="loadAdmins()">
                                <i class="fas fa-sync-alt me-2"></i> Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Admin List -->
        <div class="col-md-4">
            <div class="card border-0 shadow h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Admin Support</h5>
                </div>
                <div class="card-body p-0" style="max-height: 500px; overflow-y: auto;" id="adminList">
                    <div class="list-group list-group-flush">
                        {% if admins %}
                            {% for admin in admins %}
                            <a href="{{ url_for('chat', admin_id=admin.id) }}" 
                               class="list-group-item list-group-item-action d-flex align-items-center {{ 'active' if selected_admin == admin.id|string }} chat-admin-item"
                               data-admin-id="{{ admin.id }}">
                                <div class="flex-shrink-0">
                                    {% if admin.foto_profil %}
                                    <img src="{{ url_for('serve_upload', filename='profiles/' + admin.foto_profil) }}" 
                                         class="rounded-circle" width="40" height="40" alt="{{ admin.nama }}"
                                         onerror="this.src='{{ url_for('static', filename='img/user-placeholder.png') }}'">
                                    {% else %}
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-0">{{ admin.nama }}</h6>
                                    <small class="text-muted">Admin Support</small>
                                    <div class="small">
                                        <span class="status-dot {{ 'online' if admin.unread_count and admin.unread_count > 0 else 'offline' }}"></span>
                                        <span class="status-text">{{ 'Online' if admin.unread_count and admin.unread_count > 0 else 'Offline' }}</span>
                                    </div>
                                </div>
                                {% if admin.unread_count and admin.unread_count > 0 %}
                                <span class="badge bg-danger rounded-pill unread-badge">{{ admin.unread_count }}</span>
                                {% endif %}
                            </a>
                            {% endfor %}
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Tidak ada admin tersedia</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadAdmins()">
                                <i class="fas fa-sync-alt me-1"></i> Muat Admin
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-8">
            {% if selected_admin and current_admin %}
            <div class="card border-0 shadow h-100 d-flex flex-column">
                <!-- Chat Header -->
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        {% if current_admin.foto_profil %}
                        <img src="{{ url_for('serve_upload', filename='profiles/' + current_admin.foto_profil) }}" 
                             class="rounded-circle me-3" width="40" height="40" alt="{{ current_admin.nama }}"
                             onerror="this.src='{{ url_for('static', filename='img/user-placeholder.png') }}'">
                        {% else %}
                        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" 
                             style="width: 40px; height: 40px;">
                            <i class="fas fa-user text-primary"></i>
                        </div>
                        {% endif %}
                        <div>
                            <h5 class="mb-0">{{ current_admin.nama }}</h5>
                            <small class="text-light">{{ current_admin.email }}</small>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="typing-indicator me-3 d-none">
                            <small><i class="fas fa-pencil-alt me-1"></i> Admin sedang mengetik...</small>
                        </span>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="card-body p-0 flex-grow-1" style="height: 400px; overflow-y: auto;" id="chatMessages">
                    {% if chat_history %}
                        {% for message in chat_history %}
                        <div class="p-3 {{ 'text-end' if message.sender_id == session.user_id }}">
                            <div class="d-flex {{ 'justify-content-end' if message.sender_id == session.user_id }}">
                                {% if message.sender_id != session.user_id %}
                                <div class="flex-shrink-0 me-3">
                                    {% if message.sender_photo %}
                                    <img src="{{ url_for('serve_upload', filename='profiles/' + message.sender_photo) }}" 
                                         class="rounded-circle" width="30" height="30" alt="{{ message.sender_name }}"
                                         onerror="this.src='{{ url_for('static', filename='img/user-placeholder.png') }}'">
                                    {% else %}
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                                         style="width: 30px; height: 30px;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                <div class="{{ 'bg-light' if message.sender_id != session.user_id else 'bg-primary text-white' }} 
                                            rounded p-3" style="max-width: 70%;">
                                    <p class="mb-1">{{ message.message }}</p>
                                    <small class="{{ 'text-muted' if message.sender_id != session.user_id else 'text-light' }}">
                                        {{ message.created_at.strftime('%H:%M') }}
                                        {% if message.sender_id == session.user_id %}
                                        <i class="fas fa-check {{ 'text-muted' if not message.is_read else 'text-success' }} ms-1"></i>
                                        {% endif %}
                                    </small>
                                </div>
                                {% if message.sender_id == session.user_id %}
                                <div class="flex-shrink-0 ms-3">
                                    {% if message.sender_photo %}
                                    <img src="{{ url_for('serve_upload', filename='profiles/' + message.sender_photo) }}" 
                                         class="rounded-circle" width="30" height="30" alt="{{ message.sender_name }}"
                                         onerror="this.src='{{ url_for('static', filename='img/user-placeholder.png') }}'">
                                    {% else %}
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                                         style="width: 30px; height: 30px;">
                                        <i class="fas fa-user text-white"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                        <h5>Belum ada pesan</h5>
                        <p class="text-muted">Mulai percakapan dengan admin ini</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Chat Input -->
                <div class="card-footer">
                    <form id="chatForm" onsubmit="sendMessage(event)">
                        <div class="input-group">
                            <input type="text" class="form-control" id="messageInput" 
                                   placeholder="Ketik pesan Anda..." autocomplete="off" required
                                   oninput="handleTyping()">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Tekan Enter untuk mengirim
                            </small>
                        </div>
                    </form>
                </div>
            </div>
            {% else %}
            <!-- No Admin Selected -->
            <div class="card border-0 shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-comment-alt fa-4x text-muted mb-3"></i>
                    <h4>Pilih Admin untuk Memulai Chat</h4>
                    <p class="text-muted mb-4">Pilih salah satu admin dari daftar di sebelah kiri untuk memulai percakapan</p>
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card border">
                                <div class="card-body">
                                    <h6><i class="fas fa-headset me-2 text-primary"></i>Jam Layanan</h6>
                                    <p class="mb-1"><strong>Senin - Minggu:</strong> 24 Jam</p>
                                    <p class="mb-2"><strong>Respon:</strong> Maksimal 5 menit</p>
                                    <hr>
                                    <h6><i class="fas fa-lightbulb me-2 text-warning"></i>Tips Chat:</h6>
                                    <ul class="mb-0 small">
                                        <li>Sebutkan nama dan masalah Anda dengan jelas</li>
                                        <li>Lampirkan screenshot jika perlu</li>
                                        <li>Respon admin biasanya dalam 1-5 menit</li>
                                        <li>Riwayat chat akan disimpan</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
// Global variables
let socket = null;
const currentUserId = {{ session.user_id }};
const currentUserName = "{{ session.user_name }}";
const selectedAdminId = {{ selected_admin if selected_admin else 'null' }};
let typingTimeout = null;

// Initialize Socket.IO connection
function initSocket() {
    console.log('Initializing Socket.IO connection...');
    
    if (typeof io === 'undefined') {
        console.error('Socket.IO library not loaded');
        showAlert('Socket.IO library tidak ditemukan', 'danger');
        return;
    }
    
    // Connect to Socket.IO server
    socket = io({
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000
    });
    
    // Socket event handlers
    socket.on('connect', function() {
        console.log('Connected to chat server');
        updateConnectionStatus(true);
        
        // Join user's personal room
        socket.emit('join_user_room', { user_id: currentUserId });
        
        if (selectedAdminId) {
            // Join chat room with admin
            socket.emit('join_chat', { user_id: selectedAdminId });
        }
    });
    
    socket.on('connection_success', function(data) {
        console.log('Connection success:', data);
    });
    
    socket.on('chat_message', function(data) {
        console.log('New message received:', data);
        
        // Only process if it's for current chat
        if ((data.sender_id == selectedAdminId && data.receiver_id == currentUserId) ||
            (data.receiver_id == selectedAdminId && data.sender_id == currentUserId)) {
            addMessageToChat(data);
            scrollToBottom();
        }
    });
    
    socket.on('new_message_notification', function(data) {
        console.log('New message notification:', data);
        if (data.sender_id != currentUserId) {
            showNotification(data.sender_name, data.message);
            updateUnreadCount();
        }
    });
    
    socket.on('user_typing', function(data) {
        if (data.sender_id == selectedAdminId) {
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                if (data.is_typing) {
                    typingIndicator.classList.remove('d-none');
                } else {
                    typingIndicator.classList.add('d-none');
                }
            }
        }
    });
    
    socket.on('messages_read', function(data) {
        console.log('Messages read by admin:', data);
        // Update read status in UI
        document.querySelectorAll('.fa-check').forEach(icon => {
            icon.classList.remove('text-muted');
            icon.classList.add('text-success');
        });
    });
    
    socket.on('error', function(data) {
        console.error('Socket error:', data.message);
        showAlert('Error: ' + data.message, 'danger');
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from chat server');
        updateConnectionStatus(false);
    });
}

// Add message to chat UI
function addMessageToChat(message) {
    const chatMessages = document.getElementById('chatMessages');
    const isSender = message.sender_id == currentUserId;
    
    // Format time
    const messageTime = new Date(message.created_at);
    const time = messageTime.toLocaleTimeString('id-ID', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `p-3 ${isSender ? 'text-end' : ''}`;
    
    const senderPhoto = message.sender_photo ? 
        `<img src="/uploads/profiles/${message.sender_photo}" 
              class="rounded-circle" width="30" height="30" alt="${message.sender_name}"
              onerror="this.src='/static/img/user-placeholder.png'">` :
        `<div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
              style="width: 30px; height: 30px;">
            <i class="fas fa-user text-white"></i>
        </div>`;
    
    messageDiv.innerHTML = `
        <div class="d-flex ${isSender ? 'justify-content-end' : ''}">
            ${!isSender ? `
            <div class="flex-shrink-0 me-3">
                ${senderPhoto}
            </div>
            ` : ''}
            <div class="${isSender ? 'bg-primary text-white' : 'bg-light'} rounded p-3" style="max-width: 70%;">
                <p class="mb-1">${escapeHtml(message.message)}</p>
                <small class="${isSender ? 'text-light' : 'text-muted'}">
                    ${time}
                    ${isSender ? '<i class="fas fa-check text-light ms-1"></i>' : ''}
                </small>
            </div>
            ${isSender ? `
            <div class="flex-shrink-0 ms-3">
                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                     style="width: 30px; height: 30px;">
                    <i class="fas fa-user text-white"></i>
                </div>
            </div>
            ` : ''}
        </div>
    `;
    
    // Remove "no messages" placeholder if exists
    const placeholder = chatMessages.querySelector('.text-center');
    if (placeholder) {
        placeholder.remove();
    }
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// Scroll to bottom of chat
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    }
}

// Send message
async function sendMessage(event) {
    event.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) {
        showAlert('Pesan tidak boleh kosong', 'warning');
        return;
    }
    
    if (!selectedAdminId) {
        showAlert('Pilih admin terlebih dahulu!', 'warning');
        return;
    }
    
    // Stop typing indicator
    stopTyping();
    
    try {
        // Try Socket.IO first
        if (socket && socket.connected) {
            socket.emit('send_message', {
                receiver_id: selectedAdminId,
                message: message
            });
            
            // Add message to UI immediately
            const messageData = {
                id: Date.now(), // Temporary ID
                sender_id: currentUserId,
                receiver_id: selectedAdminId,
                message: message,
                created_at: new Date().toISOString(),
                sender_name: currentUserName,
                sender_photo: null,
                sender_role: 'customer',
                is_read: false
            };
            
            addMessageToChat(messageData);
        } else {
            // Fallback to AJAX
            await sendMessageAjax(message);
        }
        
        // Clear input
        messageInput.value = '';
        messageInput.focus();
        
    } catch (error) {
        console.error('Error sending message:', error);
        showAlert('Gagal mengirim pesan. Coba lagi.', 'danger');
    }
}

// AJAX fallback for sending messages
async function sendMessageAjax(message) {
    try {
        const response = await fetch("/api/chat/send", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                receiver_id: selectedAdminId,
                message: message
            })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Failed to send message');
        }
        
        // Add message to UI
        addMessageToChat(data.message_data);
        
    } catch (error) {
        console.error('Error sending message via AJAX:', error);
        throw error;
    }
}

// Handle typing
function handleTyping() {
    if (!selectedAdminId || !socket || !socket.connected) return;
    
    // Clear previous timeout
    if (typingTimeout) {
        clearTimeout(typingTimeout);
    }
    
    // Emit typing start
    socket.emit('typing', {
        receiver_id: selectedAdminId,
        is_typing: true
    });
    
    // Set timeout to stop typing after 2 seconds of inactivity
    typingTimeout = setTimeout(() => {
        stopTyping();
    }, 2000);
}

// Stop typing indicator
function stopTyping() {
    if (!selectedAdminId || !socket || !socket.connected) return;
    
    if (typingTimeout) {
        clearTimeout(typingTimeout);
        typingTimeout = null;
    }
    
    socket.emit('typing', {
        receiver_id: selectedAdminId,
        is_typing: false
    });
}

// Load admins via API
async function loadAdmins() {
    try {
        const response = await fetch('/api/chat/partners');
        const data = await response.json();
        
        if (data.success) {
            const adminList = document.getElementById('adminList');
            const listGroup = adminList.querySelector('.list-group-flush');
            
            listGroup.innerHTML = '';
            
            if (data.partners && data.partners.length > 0) {
                data.partners.forEach(admin => {
                    const item = document.createElement('a');
                    item.href = `/chat?admin_id=${admin.id}`;
                    item.className = `list-group-item list-group-item-action d-flex align-items-center chat-admin-item`;
                    item.dataset.adminId = admin.id;
                    
                    item.innerHTML = `
                        <div class="flex-shrink-0">
                            ${admin.foto_profil ? 
                                `<img src="/uploads/profiles/${admin.foto_profil}" 
                                      class="rounded-circle" width="40" height="40" alt="${admin.nama}"
                                      onerror="this.src='/static/img/user-placeholder.png'">` :
                                `<div class="rounded-circle bg-primary d-flex align-items-center justify-content-center" 
                                      style="width: 40px; height: 40px;">
                                    <i class="fas fa-user text-white"></i>
                                </div>`}
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">${escapeHtml(admin.nama)}</h6>
                            <small class="text-muted">Admin Support</small>
                            <div class="small">
                                <span class="status-dot ${admin.unread_count > 0 ? 'online' : 'offline'}"></span>
                                <span class="status-text">${admin.unread_count > 0 ? 'Online' : 'Offline'}</span>
                            </div>
                        </div>
                        ${admin.unread_count > 0 ? 
                            `<span class="badge bg-danger rounded-pill unread-badge">${admin.unread_count}</span>` : ''}
                    `;
                    
                    listGroup.appendChild(item);
                });
            } else {
                listGroup.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Tidak ada admin tersedia</p>
                        <p class="small text-muted">Coba refresh beberapa saat lagi</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading admins:', error);
        showAlert('Gagal memuat daftar admin', 'danger');
    }
}

// Update unread count
async function updateUnreadCount() {
    try {
        const response = await fetch('/api/chat/unread-count');
        const data = await response.json();
        
        if (data.success) {
            // Update badge in admin list
            const adminBadge = document.querySelector(`.chat-admin-item[data-admin-id="${selectedAdminId}"] .unread-badge`);
            if (adminBadge) {
                if (data.count === 0) {
                    adminBadge.style.display = 'none';
                } else {
                    adminBadge.style.display = 'inline-block';
                    adminBadge.textContent = data.count;
                }
            }
        }
    } catch (error) {
        console.error('Error updating unread count:', error);
    }
}

// Update connection status
function updateConnectionStatus(connected) {
    const statusIndicator = document.querySelector('.connection-status');
    if (statusIndicator) {
        if (connected) {
            statusIndicator.innerHTML = '<i class="fas fa-circle text-success"></i> Connected';
            statusIndicator.className = 'connection-status badge bg-success rounded-pill p-2 me-3';
        } else {
            statusIndicator.innerHTML = '<i class="fas fa-circle text-danger"></i> Disconnected';
            statusIndicator.className = 'connection-status badge bg-danger rounded-pill p-2 me-3';
        }
    }
}

// Show alert
function showAlert(message, type) {
    // Remove existing alerts
    document.querySelectorAll('.alert-fixed').forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-fixed position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Show notification
function showNotification(title, message) {
    if (Notification.permission === 'granted') {
        new Notification(title, {
            body: message,
            icon: '/static/img/favicon.ico'
        });
    }
}

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Auto scroll to bottom
    scrollToBottom();
    
    // Initialize Socket.IO
    initSocket();
    
    // Update unread count
    if (selectedAdminId) {
        updateUnreadCount();
    }
    
    // Add Enter key support
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chatForm').dispatchEvent(new Event('submit'));
            }
        });
        
        // Request notification permission
        if (Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }
    
    // Load admins on page load
    setTimeout(() => {
        loadAdmins();
    }, 1000);
});
</script>

<style>
.status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 5px;
}

.status-dot.online {
    background-color: #28a745;
}

.status-dot.offline {
    background-color: #6c757d;
}

.alert-fixed {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
}

.chat-admin-item.active {
    background-color: #e3f2fd;
    border-left: 4px solid #0d6efd;
}
</style>
{% endblock %}